name: Build Android APK

on:
  pull_request:
    branches: [ master ]
    types: [ closed ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'release'
        type: choice
        options:
        - release
        - debug

jobs:
  build-android:
    if: github.event.pull_request.merged == true || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ 
            github.event_name == 'pull_request' && github.event.pull_request.merge_commit_sha ||
            github.event_name == 'push' && github.ref ||
            github.sha
          }}

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Grant permissions for Gradle wrapper
        run: chmod +x ./gradlew

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # åˆ›å»º keystore æ–‡ä»¶ï¼ˆä½¿ç”¨ Gradle å†…ç½®ç­¾åï¼‰
      - name: Create keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_SIGNING_KEYSTORE_BASE64 }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 -d > keystore.jks
          echo "âœ… Keystore created successfully"

      # ä½¿ç”¨ Gradle å†…ç½®ç­¾åæ„å»º
      - name: Build signed APK
        env:
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          BUILD_TYPE=${{ github.event.inputs.build_type || 'release' }}
          echo "ğŸ”¨ Building $BUILD_TYPE APK..."
          ./gradlew :composeApp:assemble${BUILD_TYPE^} --no-daemon --stacktrace
          echo "âœ… Signed APK build completed"

      # æŸ¥æ‰¾å¹¶é‡å‘½åAPKæ–‡ä»¶
      - name: Prepare APK
        run: |
          BUILD_TYPE=${{ github.event.inputs.build_type || 'release' }}
          
          # æŸ¥æ‰¾APKæ–‡ä»¶
          if [[ "$BUILD_TYPE" == "release" ]]; then
            APK_PATH="composeApp/build/outputs/apk/release/composeApp-release.apk"
          else
            APK_PATH="composeApp/build/outputs/apk/debug/composeApp-debug.apk"
          fi
          
          if [[ ! -f "$APK_PATH" ]]; then
            echo "âŒ APK file not found at $APK_PATH"
            exit 1
          fi
          
          # è·å–ç‰ˆæœ¬ä¿¡æ¯
          VERSION_NAME=$(./gradlew -q printVersionName | tail -n 1)
          VERSION_CODE=$(./gradlew -q printVersionCode | tail -n 1)
          
          # åˆ›å»ºæœ€ç»ˆAPKæ–‡ä»¶å
          TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
          FINAL_APK_NAME="composeApp-${BUILD_TYPE}-v${VERSION_NAME:-unknown}-${VERSION_CODE:-0}-${TIMESTAMP}.apk"
          
          # å¤åˆ¶å¹¶é‡å‘½åAPK
          cp "$APK_PATH" "$FINAL_APK_NAME"
          
          # è·å–APKä¿¡æ¯
          APK_SIZE=$(du -h "$FINAL_APK_NAME" | cut -f1)
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          echo "FINAL_APK_NAME=$FINAL_APK_NAME" >> $GITHUB_ENV
          echo "APK_SIZE=$APK_SIZE" >> $GITHUB_ENV
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_ENV
          echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_ENV
          echo "BUILD_TYPE=$BUILD_TYPE" >> $GITHUB_ENV
          
          echo "âœ… APK prepared: $FINAL_APK_NAME (Size: $APK_SIZE)"

      # éªŒè¯APKç­¾åï¼ˆä»…å¯¹releaseç‰ˆæœ¬ï¼‰
      - name: Verify APK signature
        if: env.BUILD_TYPE == 'release'
        run: |
          # æŸ¥æ‰¾æœ€æ–°çš„build-toolsç‰ˆæœ¬
          BUILD_TOOLS_VERSION=$(ls $ANDROID_HOME/build-tools | sort -V | tail -n 1)
          APKSIGNER="$ANDROID_HOME/build-tools/$BUILD_TOOLS_VERSION/apksigner"
          
          if [[ ! -f "$APKSIGNER" ]]; then
            echo "âŒ apksigner not found at $APKSIGNER"
            exit 1
          fi
          
          # éªŒè¯ç­¾å
          "$APKSIGNER" verify "$FINAL_APK_NAME"
          echo "âœ… APK signature verified successfully"

      # æ¸…ç†æ•æ„Ÿæ–‡ä»¶
      - name: Cleanup sensitive files
        if: always()
        run: |
          rm -f keystore.jks
          echo "ğŸ§¹ Sensitive files cleaned up"

      # ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-${{ env.BUILD_TYPE }}-${{ github.run_number }}
          path: ${{ env.FINAL_APK_NAME }}
          retention-days: 30

      # æˆåŠŸé€šçŸ¥
      - name: Notify build success
        if: success()
        run: |
          echo "ğŸ‰ APK æ„å»ºæˆåŠŸï¼"
          echo "ğŸ“¦ æ–‡ä»¶å: ${{ env.FINAL_APK_NAME }}"
          echo "ğŸ“ å¤§å°: ${{ env.APK_SIZE }}"
          echo "ğŸ·ï¸ ç‰ˆæœ¬: ${{ env.VERSION_NAME }} (Build ${{ env.VERSION_CODE }})"
          echo "ğŸ”§ æ„å»ºç±»å‹: ${{ env.BUILD_TYPE }}"

      # å¤±è´¥é€šçŸ¥
      - name: Notify build failure
        if: failure()
        run: |
          echo "âŒ APK æ„å»ºå¤±è´¥ï¼"
          echo "ğŸ” è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—ä»¥è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯"
          echo "ğŸ“‹ æ„å»ºå‚æ•°:"
          echo "  - æ„å»ºç±»å‹: ${{ env.BUILD_TYPE || 'release' }}"
          echo "  - è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "  - åˆ†æ”¯/æ ‡ç­¾: ${{ github.ref }}"
